---
title: "gloBarAnalysis"
author: "ian enochs"
date: "2024-03-10"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

### GLOBAL BMU Analysis
This document was created to analyze NCRMP BMU data

```{r, echo=FALSE}
library(readxl)
library(dplyr)
library(magrittr)
library(ggplot2)
library(ggpubr)
library(lubridate)

#get data
rootFolder <-getwd() #get root folder
atlanticBarData_raw <- read_excel(paste(rootFolder,"/data/NCRMP_Atlantic_allBmuData_March2024.xlsx",sep=""))#import data
pacificBarData_raw <- read_excel(paste(rootFolder,"/data/NCRMP_Pacific_allBmuData_March2024.xlsx",sep=""))#import data
allBarData_raw <- rbind(atlanticBarData_raw, pacificBarData_raw)
allBarData_clean <- allBarData_raw %>% 
  filter(fate=='SUCCESSFULLY RECOVERED') %>% #remove bars that weren't recovered
  filter(species!='Isopora sp.') %>% #remove bars made of Isopora
  select(-c(dimensions,carbMDPre, carbEQPre, carbMDPost,carbEQPre)) %>% #remove unnecessary columns
  mutate(daysDeployed = as.numeric(ymd(dateRecovery) - ymd(dateDeployment))) %>% 
  mutate(yearsDeployed=daysDeployed/365)

#standardize data to surface area and days.
preSA = 24 #cm2 of exterior facing bar in a 2 x 1 x 5 cm block
allBarData_clean <- allBarData_clean  %>% 

#CHECK IF CORRECT  
  mutate(grazing = volumeBlockPost-macroboring-volumeBlockPre) %>%  #calculates grazing as volume in block change not including macroboring
  mutate(deltaMass_mgcm2y = 1000*(massCleanPost-massEpoxiedPre)/preSA/yearsDeployed) %>%  
  mutate(deltaVolume_mm3cm2y = 1000*(volumeBlockPost-volumeBlockPre)/preSA/yearsDeployed) %>%  
  mutate(deltaDensity_mgcm3cm2y = 1000*(densityCTPost-densityCTPre)/preSA/yearsDeployed) %>%  
  mutate(macroboring_mm3cm2y = 1000*macroboring/preSA/yearsDeployed) %>%  
  mutate(accretion_mm3cm2y = 1000*accretion/preSA/yearsDeployed) %>% 
  mutate(grazing_mm3cm2y = 1000*grazing/preSA/yearsDeployed)
```

## QA/QC of deltaMass_mgcm2y
Tags where deltaMass_mgcm2y = "NA":
```{r, echo=FALSE}
  allBarData_clean$tagNum[which(is.na(allBarData_clean$deltaMass_mgcm2y))]
```
Historgram of deltaMass_mgcm2y values
```{r, echo=FALSE}
  ggplot(allBarData_clean, aes(x = deltaMass_mgcm2y)) +
  geom_histogram(binwidth = 5, color = "black", fill = "white") +
  labs(title = "Histogram of deltaMass_mgcm2y", x = "deltaMass_mgcm2y", y = "Frequency")
```

## QA/QC of deltaVolume_mm3cm2y
Tags where deltaVolume_mm3cm2y = "NA":
```{r, echo=FALSE}
allBarData_clean$tagNum[which(is.na(allBarData_clean$deltaVolume_mm3cm2y))]
```
Historgram of deltaVolume_mm3cm2y values
```{r, echo=FALSE}
  ggplot(allBarData_clean, aes(x = deltaVolume_mm3cm2y)) +
  geom_histogram(binwidth = 5, color = "black", fill = "white") +
  labs(title = "Histogram of deltaVolume_mm3cm2y", x = "deltaVolume_mm3cm2y", y = "Frequency")
```

## QA/QC of deltaDensity_mgcm3cm2y
Tags where deltaDensity_mgcm3cm2y = "NA":
```{r checkNADensity, echo=FALSE}
allBarData_clean$tagNum[which(is.na(allBarData_clean$deltaDensity_mgcm3cm2y))]
```
Historgram of deltaDensity_mgcm3cm2y values
```{r, echo=FALSE}
  ggplot(allBarData_clean, aes(x = deltaDensity_mgcm3cm2y)) +
  geom_histogram(binwidth = .1, color = "black", fill = "white") +
  labs(title = "Histogram of deltaDensity_mgcm3cm2y", x = "deltaDensity_mgcm3cm2y", y = "Frequency")
```


## QA/QC of macroboring_mm3cm2y
Tags where macroboring_mm3cm2y = "NA":
```{r checkNAMacroboring, echo=FALSE}
allBarData_clean$tagNum[which(is.na(allBarData_clean$macroboring_mm3cm2y))]
```
Historgram of macroboring_mm3cm2y values
```{r, echo=FALSE}
  ggplot(allBarData_clean, aes(x = macroboring_mm3cm2y)) +
  geom_histogram(binwidth = 1, color = "black", fill = "white") +
  labs(title = "Histogram of macroboring_mm3cm2y", x = "macroboring_mm3cm2y", y = "Frequency")
```

## QA/QC of accretion_mm3cm2y
Tags where accretion_mm3cm2y = "NA":
```{r checkNAAccretion, echo=FALSE}
allBarData_clean$tagNum[which(is.na(allBarData_clean$accretion_mm3cm2y))]
```
Historgram of accretion_mm3cm2y values
```{r, echo=FALSE}
  ggplot(allBarData_clean, aes(x = accretion_mm3cm2y)) +
  geom_histogram(binwidth = 5, color = "black", fill = "white") +
  labs(title = "Histogram of accretion_mm3cm2y", x = "accretion_mm3cm2y", y = "Frequency")
```

## QA/QC of grazing_mm3cm2y
Tags where grazing_mm3cm2y = "NA":
```{r, echo=FALSE}
allBarData_clean$tagNum[which(is.na(allBarData_clean$grazing_mm3cm2y))]
```
Tags where grazing_mm3cm2y > 0 and list of those values:
```{r, echo=FALSE}
allBarData_clean$tagNum[which(allBarData_clean$grazing_mm3cm2y>0)]
allBarData_clean$grazing_mm3cm2y[which(allBarData_clean$grazing_mm3cm2y>0)]
```
Historgram of grazing_mm3cm2y values
```{r, echo=FALSE}
  ggplot(allBarData_clean, aes(x = grazing_mm3cm2y)) +
  geom_histogram(binwidth = 5, color = "black", fill = "white") +
  labs(title = "Histogram of grazing_mm3cm2y", x = "grazing_mm3cm2y", y = "Frequency")
```


## General trends
Plot of deltaVolume_mm3cm2y vs. deltaMass_mgcm2y:
```{r, echo=FALSE}

p <- ggplot(allBarData_clean, aes(x = deltaMass_mgcm2y, y = deltaVolume_mm3cm2y)) +
  geom_point() +  # Scatterplot
  geom_smooth(method = "lm", se = TRUE) +  # Regression line
  theme_minimal()

# Calculate R-squared value
lm_model_volVsMass <- lm(deltaVolume_mm3cm2y ~ deltaMass_mgcm2y, data = allBarData_clean)
r_squared_volVsMass <- summary(lm_model_volVsMass)$r.squared


p + geom_text(data = subset(allBarData_clean, deltaMass_mgcm2y > 100), aes(label = tagNum), 
            hjust = -0.1, vjust = -0.5, size = 2)+# Add tag numbers here delta mass is greater than 100
    geom_text(x = 200, y = -100, label = paste("R^2 =", round(r_squared_volVsMass, 2)), size = 3)# Add R-squared value to the plot
```

Plot of deltaMass_mgcm2y vs. daysDeployed:
```{r, echo=FALSE}

p <- ggplot(allBarData_clean, aes(x = daysDeployed, y = deltaMass_mgcm2y)) +
  geom_point() +  # Scatterplot
  geom_smooth(method = "lm", se = TRUE) +  # Regression line
  theme_minimal()

# Calculate R-squared value
lm_model_massVsDays <- lm(deltaMass_mgcm2y ~ daysDeployed, data = allBarData_clean)
r_squared_massVsDays <- summary(lm_model_massVsDays)$r.squared

# Add R-squared value to the plot
p + geom_text(data = subset(allBarData_clean, daysDeployed > 2500), aes(label = tagNum), 
            hjust = -0.1, vjust = -0.5, size = 2)+# Add tag numbers here where days deployed is greater than 2500
    geom_text(x = 2500, y = -100, label = paste("R^2 =", round(r_squared_massVsDays, 2)), size = 3)
```